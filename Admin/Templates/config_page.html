<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        .ai-config-container { max-width: 900px; margin: 20px; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .alert-success { background-color: #d4edda; color: #155724; }
        .alert-danger { background-color: #f8d7da; color: #721c24; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .backup-warning { margin-bottom: 30px; }
        .backup-dirs { margin: 15px 0; padding: 10px; background: #fffbf0; border-left: 4px solid #ff9800; }
        .backup-dirs ul { margin: 10px 0; padding-left: 20px; }
        .backup-dirs li { margin: 5px 0; font-family: monospace; font-size: 13px; }
        .backup-dirs code { background: #fff; padding: 2px 6px; border-radius: 3px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; }
        textarea.form-control { min-height: 150px; resize: vertical; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .help-block { font-size: 12px; color: #666; margin-top: 5px; }
        .section-title { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd; }
        .placeholder-info { background: #f8f9fa; padding: 10px; margin-top: 10px; border-left: 3px solid #007bff; }
        .placeholder-info code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
<div class="ai-config-container">
    <h1>ü§ñ AI Product Optimizer - Konfiguration</h1>
    
    {if $success}
    <div class="alert alert-success">‚úì Konfiguration erfolgreich gespeichert!</div>
    {/if}
    {if $error}
    <div class="alert alert-danger">‚úó Bitte API Key eingeben!</div>
    {/if}

    {if $backupWarning}
    <div class="alert alert-warning backup-warning">
        <h3 style="margin-top: 0;">‚ö†Ô∏è WARNUNG: Backup-Verzeichnisse gefunden!</h3>
        <p><strong>{$backupWarning.message}</strong></p>

        <div class="backup-dirs">
            <p><strong>Gefundene Backup-Verzeichnisse ({$backupWarning.count}):</strong></p>
            <ul>
                {foreach from=$backupWarning.directories item=dir}
                <li><code>{$dir.name}</code> ({$dir.size})</li>
                {/foreach}
            </ul>
        </div>

        <h4>üîß Sofortige Behebung erforderlich:</h4>
        <p>Diese Backup-Verzeichnisse befinden sich im aktiven Modul-Pfad und k√∂nnen zu folgenden Fehlern f√ºhren:</p>
        <ul>
            <li><strong>Fatal error: Cannot declare class AIProductOptimizerModuleCenterModuleController</strong></li>
            <li>Kompletter Shop-Ausfall durch PHP-Fehler</li>
            <li>ClassFinder-Konflikte</li>
        </ul>

        <h4>üìã L√∂sung:</h4>
        <ol>
            <li>Verbinden Sie sich per SSH/FTP mit Ihrem Server</li>
            <li>Navigieren Sie zu: <code>GXModules/REDOzone/</code></li>
            <li>Verschieben Sie die Backup-Verzeichnisse au√üerhalb des Modul-Pfads:
                <br><code style="display: block; margin: 10px 0; padding: 10px; background: #333; color: #0f0;">
                # Beispiel f√ºr SSH:<br>
                cd /srv/www/IhrShop/GXModules/REDOzone/<br>
                mkdir -p /backups/module_backups/<br>
                mv AIProductOptimizer_BACKUP_* /backups/module_backups/
                </code>
            </li>
            <li>Laden Sie diese Seite neu um zu pr√ºfen ob die Warnung verschwunden ist</li>
        </ol>

        <p><strong>WICHTIG:</strong> Erstellen Sie zuk√ºnftige Backups immer au√üerhalb von <code>GXModules/</code>!</p>
    </div>
    {/if}

    <form action="admin.php?do=AIProductOptimizerModuleCenterModule/Save" method="post">
        
        <h2>üîë API-Einstellungen</h2>
        
        <div class="form-group">
            <label>OpenAI API Key *</label>
            <input type="text" class="form-control" name="openai_key" value="{$apiKey|escape}" required>
            <p class="help-block">API Key von <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>
        </div>

        <div class="form-group">
            <label>OpenAI Project ID (optional)</label>
            <input type="text" class="form-control" name="project_id" value="{$projectId|escape}" placeholder="proj_...">
            <p class="help-block">Project ID f√ºr OpenAI Project-Keys (erforderlich f√ºr neuere Modelle wie GPT-5). Format: proj_xxxxxxxxxx</p>
        </div>

        <div class="form-group">
            <label>Modell</label>
            <select class="form-control" name="model" id="model-select">
                {if $availableModels && count($availableModels) > 0}
                    {foreach from=$availableModels item=modelOption}
                        <option value="{$modelOption.id}" {if $model == $modelOption.id}selected{/if}>{$modelOption.name}</option>
                    {/foreach}
                {else}
                    <option value="gpt-4o-mini" {if $model == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (empfohlen, g√ºnstig)</option>
                    <option value="gpt-4o" {if $model == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualit√§t)</option>
                {/if}
            </select>
        </div>
        
        <div class="form-group">
            <button type="button" class="btn btn-secondary" onclick="updateModels()">
                üîÑ Modelle von OpenAI aktualisieren
            </button>
            <p class="help-block" id="update-status"></p>
        </div>
        
        <h2 class="section-title">üìù Prompt-Konfiguration (Produkttexte)</h2>

        <div class="form-group">
            <label>System-Prompt</label>
            <textarea class="form-control" name="system_prompt" rows="4">{$systemPrompt|escape}</textarea>
            <p class="help-block">Definiert die Rolle und das grunds√§tzliche Verhalten der KI f√ºr Produkttext-Generierung</p>
            <button type="button" class="btn btn-info btn-sm" onclick="resetSystemPrompt()">Standard wiederherstellen</button>
        </div>
        
        <div class="form-group">
            <label>User-Prompt (Aufgabenstellung)</label>
            <textarea class="form-control" name="user_prompt" rows="20">{$userPrompt|escape}</textarea>
            <p class="help-block">Template f√ºr die Aufgabenstellung. Verwenden Sie Platzhalter f√ºr dynamische Inhalte:</p>
            <div class="placeholder-info">
                <strong>Verf√ºgbare Platzhalter:</strong><br>
                <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                <code>{literal}{ldelim}ORIGINAL_TEXT{rdelim}{/literal}</code> - Original Produktbeschreibung<br>
                <code>{literal}{ldelim}LANGUAGE{rdelim}{/literal}</code> - Zielsprache<br>
                <code>{literal}{ldelim}BRAND_LINE{rdelim}{/literal}</code> - Marke (falls vorhanden)<br>
                <code>{literal}{ldelim}CATEGORY_LINE{rdelim}{/literal}</code> - Kategorie (falls vorhanden)
            </div>
            <button type="button" class="btn btn-info btn-sm" onclick="resetUserPrompt()">Standard wiederherstellen</button>
        </div>

        <div class="form-group" style="background: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin-top: 20px;">
            <h4 style="margin-top: 0;">üìö Prompt-Bibliothek f√ºr Produkttexte</h4>
            <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen f√ºr die Produkttext-Generierung.</p>
            <button type="button" class="btn btn-primary" onclick="showProductPromptLibrary()">üìñ Bibliothek √∂ffnen</button>
        </div>

        <h2 class="section-title">üñºÔ∏è ALT-Text-Generierung (Barrierefreiheit)</h2>

        <div class="form-group">
            <label>Vision-Modell</label>
            <select class="form-control" name="vision_model" id="vision-model-select">
                <option value="gpt-4o" {if $visionModel == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualit√§t, empfohlen)</option>
                <option value="gpt-4o-mini" {if $visionModel == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (schneller, g√ºnstiger)</option>
            </select>
            <p class="help-block">Modell f√ºr die Bild-Analyse und ALT-Text-Generierung</p>
        </div>

        <div class="form-group">
            <label>System-Prompt f√ºr ALT-Texte</label>
            <textarea class="form-control" name="vision_system_prompt" rows="4">{$visionSystemPrompt|escape}</textarea>
            <p class="help-block">Definiert die Rolle f√ºr barrierefreie Bildbeschreibungen</p>
            <button type="button" class="btn btn-info btn-sm" onclick="resetVisionSystemPrompt()">Standard wiederherstellen</button>
        </div>

        <div class="form-group">
            <label>User-Prompt f√ºr ALT-Texte</label>
            <textarea class="form-control" name="vision_user_prompt" rows="15">{$visionUserPrompt|escape}</textarea>
            <p class="help-block">Template f√ºr die ALT-Text-Generierung. Platzhalter werden automatisch ersetzt.</p>
            <div class="placeholder-info">
                <strong>Verf√ºgbare Platzhalter:</strong><br>
                <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                <code>{literal}{ldelim}LANGUAGES{rdelim}{/literal}</code> - Liste der gew√ºnschten Sprachen
            </div>
            <button type="button" class="btn btn-info btn-sm" onclick="resetVisionUserPrompt()">Standard wiederherstellen</button>
        </div>

        <div class="form-group" style="background: #f8f9fa; padding: 15px; border-left: 4px solid #17a2b8; margin-top: 20px;">
            <h4 style="margin-top: 0;">üìö Prompt-Bibliothek f√ºr ALT-Texte</h4>
            <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen f√ºr die ALT-Text-Generierung.</p>
            <button type="button" class="btn btn-primary" onclick="showVisionPromptLibrary()">üìñ Bibliothek √∂ffnen</button>
        </div>

        <button type="submit" class="btn btn-primary">üíæ Speichern</button>
        <a href="admin.php?do=ModuleCenter" class="btn">‚Üê Zur√ºck</a>
    </form>

    <!-- Modal f√ºr neuen Prompt -->
    <div id="add-prompt-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 800px; margin: 50px auto; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3>üìù Neuen Prompt speichern</h3>
            <div class="form-group">
                <label>Label/Name *</label>
                <input type="text" class="form-control" id="new-prompt-label" placeholder="z.B. SEO-optimiert, Verkaufsorientiert, Technisch">
            </div>
            <div class="form-group">
                <label>Beschreibung</label>
                <textarea class="form-control" id="new-prompt-description" rows="2" placeholder="Optionale Beschreibung f√ºr diesen Prompt"></textarea>
            </div>
            <div class="form-group">
                <label>System-Prompt *</label>
                <textarea class="form-control" id="new-prompt-system" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>User-Prompt *</label>
                <textarea class="form-control" id="new-prompt-user" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="new-prompt-default"> Als Standard-Prompt setzen
                </label>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveNewPrompt()">üíæ Prompt speichern</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddPromptDialog()">Abbrechen</button>
            <p id="save-prompt-status" class="help-block"></p>
        </div>
    </div>

    <!-- Modal f√ºr Prompt bearbeiten -->
    <div id="edit-prompt-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; max-width: 800px; margin: 50px auto; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3>‚úèÔ∏è Prompt bearbeiten</h3>
            <input type="hidden" id="edit-prompt-id">
            <div class="form-group">
                <label>Label/Name *</label>
                <input type="text" class="form-control" id="edit-prompt-label">
            </div>
            <div class="form-group">
                <label>Beschreibung</label>
                <textarea class="form-control" id="edit-prompt-description" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>System-Prompt *</label>
                <textarea class="form-control" id="edit-prompt-system" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>User-Prompt *</label>
                <textarea class="form-control" id="edit-prompt-user" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-prompt-default"> Als Standard-Prompt setzen
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit-prompt-active" checked> Aktiv
                </label>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveEditedPrompt()">üíæ √Ñnderungen speichern</button>
            <button type="button" class="btn btn-secondary" onclick="hideEditPromptDialog()">Abbrechen</button>
            <p id="edit-prompt-status" class="help-block"></p>
        </div>
    </div>

    <!-- Modal f√ºr Produkttext Prompt-Bibliothek -->
    <div id="product-library-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="if(event.target.id==='product-library-modal') hideProductLibrary();">
        <div style="background: white; max-width: 1000px; margin: 30px auto; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3 style="border-left: 4px solid #007bff; padding-left: 15px;">üìö Prompt-Bibliothek f√ºr Produkttexte</h3>
            <p>Verwalten Sie Ihre gespeicherten Prompt-Vorlagen f√ºr die Produkttext-Generierung.</p>

            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="showAddPromptDialog('product')">‚ûï Neuen Prompt erstellen</button>
                <button type="button" class="btn btn-secondary" style="float: right;" onclick="hideProductLibrary()">‚úï Schlie√üen</button>
            </div>

            <div id="product-library-list"></div>
        </div>
    </div>

    <!-- Modal f√ºr Vision/ALT-Text Prompt-Bibliothek -->
    <div id="vision-library-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;" onclick="if(event.target.id==='vision-library-modal') hideVisionLibrary();">
        <div style="background: white; max-width: 1000px; margin: 30px auto; padding: 30px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h3 style="border-left: 4px solid #17a2b8; padding-left: 15px;">üìö Prompt-Bibliothek f√ºr ALT-Texte</h3>
            <p>Verwalten Sie Ihre gespeicherten Prompt-Vorlagen f√ºr die barrierefreie ALT-Text-Generierung.</p>

            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="showAddPromptDialog('vision')">‚ûï Neuen Prompt erstellen</button>
                <button type="button" class="btn btn-secondary" style="float: right;" onclick="hideVisionLibrary()">‚úï Schlie√üen</button>
            </div>

            <div id="vision-library-list"></div>
        </div>
    </div>

    <hr style="margin-top: 40px;">
    <h3>üìù Verwendung</h3>
    <ol>
        <li>Konfigurieren Sie Ihren OpenAI API Key und w√§hlen Sie ein Modell</li>
        <li>Passen Sie optional die Prompts an Ihre Bed√ºrfnisse an</li>
        <li>√ñffnen Sie ein Produkt in der Artikelverwaltung</li>
        <li>Klicken Sie auf "SEO-Texte mit KI generieren"</li>
        <li>Warten Sie ~40 Sekunden w√§hrend die Texte generiert werden</li>
    </ol>
</div>

<script>
var defaultSystemPrompt = 'Du bist ein professioneller E-Commerce SEO-Texter. Du antwortest immer im angeforderten JSON-Format.';

var defaultUserPrompt = `Du bist ein Experte f√ºr E-Commerce SEO und Produkttexte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}
{ldelim}BRAND_LINE{rdelim}{ldelim}CATEGORY_LINE{rdelim}
Original-Produkttext:
{ldelim}ORIGINAL_TEXT{rdelim}

AUFGABE:
Erstelle einen SEO-optimierten Produkttext in {ldelim}LANGUAGE{rdelim}. Beachte folgende Anforderungen:

1. Schreibe einen verkaufsstarken, informativen Produkttext (300-500 W√∂rter)
2. Integriere relevante Keywords nat√ºrlich
3. Strukturiere den Text mit Abs√§tzen f√ºr bessere Lesbarkeit
4. Hebe Vorteile und Nutzen hervor
5. Erstelle einen pr√§gnanten Meta-Titel (max. 60 Zeichen)
6. Erstelle eine √ºberzeugende Meta-Description (max. 160 Zeichen)

FORMAT DER ANTWORT (JSON):
{
  "product_description": "Der optimierte Produkttext hier...",
  "meta_title": "SEO Meta-Titel",
  "meta_description": "SEO Meta-Description"
}

Antworte NUR mit dem JSON-Objekt, ohne zus√§tzlichen Text.`;

function resetSystemPrompt() {
    if (confirm('System-Prompt auf Standard zur√ºcksetzen?')) {
        document.querySelector('textarea[name="system_prompt"]').value = defaultSystemPrompt;
    }
}

function resetUserPrompt() {
    if (confirm('User-Prompt auf Standard zur√ºcksetzen?')) {
        document.querySelector('textarea[name="user_prompt"]').value = defaultUserPrompt;
    }
}

var defaultVisionSystemPrompt = 'Du bist ein Experte f√ºr barrierefreie Bildbeschreibungen. Du erstellst pr√§zise, informative ALT-Texte f√ºr Produktbilder, die f√ºr Screenreader-Nutzer optimal geeignet sind.';

var defaultVisionUserPrompt = `Analysiere dieses Produktbild und erstelle barrierefreie ALT-Texte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}

WICHTIG f√ºr barrierefreie ALT-Texte:
- Beschreibe WAS auf dem Bild zu sehen ist (nicht WIE es aussieht)
- Fokussiere auf das Produkt und seine erkennbaren Eigenschaften
- Halte die Beschreibung pr√§zise aber informativ (ca. 50-100 Zeichen)
- Vermeide subjektive Bewertungen wie "sch√∂n" oder "hochwertig"
- Beschreibe erkennbare Details: Farbe, Form, Material, Anzahl

Erstelle ALT-Texte f√ºr folgende Sprachen:
{ldelim}LANGUAGES{rdelim}

Antworte NUR mit einem JSON-Objekt in diesem Format:
{
  "de": "ALT-Text in Deutsch",
  "en": "ALT-text in English",
  ...
}`;

function resetVisionSystemPrompt() {
    if (confirm('Vision System-Prompt auf Standard zur√ºcksetzen?')) {
        document.querySelector('textarea[name="vision_system_prompt"]').value = defaultVisionSystemPrompt;
    }
}

function resetVisionUserPrompt() {
    if (confirm('Vision User-Prompt auf Standard zur√ºcksetzen?')) {
        document.querySelector('textarea[name="vision_user_prompt"]').value = defaultVisionUserPrompt;
    }
}

function updateModels() {
    var statusEl = document.getElementById('update-status');
    statusEl.innerHTML = '‚è≥ Lade Modelle von OpenAI...';
    statusEl.style.color = '#666';

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdateModels', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.innerHTML = '‚úì ' + data.count + ' Modelle aktualisiert. Seite wird neu geladen...';
            statusEl.style.color = '#28a745';
            setTimeout(() => location.reload(), 1500);
        } else {
            statusEl.innerHTML = '‚ùå Fehler: ' + data.error;
            statusEl.style.color = '#dc3545';
        }
    })
    .catch(error => {
        statusEl.innerHTML = '‚ùå Fehler: ' + error.message;
        statusEl.style.color = '#dc3545';
    });
}

// ============================================================
// Prompt Library Functions
// ============================================================

function loadPromptLibrary(promptType) {
    var listEl = document.getElementById('prompt-library-list');
    listEl.innerHTML = '<p style="color: #666;">‚è≥ Lade Prompts...</p>';

    var url = 'admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=1';
    if (promptType) {
        url += '&prompt_type=' + promptType;
    }

    fetch(url)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPromptLibrary(data.prompts, promptType);
        } else {
            listEl.innerHTML = '<p style="color: #dc3545;">‚ùå Fehler: ' + data.error + '</p>';
        }
    })
    .catch(error => {
        listEl.innerHTML = '<p style="color: #dc3545;">‚ùå Fehler: ' + error.message + '</p>';
    });
}

function displayPromptLibrary(prompts) {
    var listEl = document.getElementById('prompt-library-list');

    if (prompts.length === 0) {
        listEl.innerHTML = '<p style="color: #666;">Noch keine Prompts gespeichert. Klicken Sie auf "Neuen Prompt speichern" um zu beginnen.</p>';
        return;
    }

    var html = '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">';
    html += '<th style="padding: 10px; text-align: left;">Label</th>';
    html += '<th style="padding: 10px; text-align: left;">Beschreibung</th>';
    html += '<th style="padding: 10px; text-align: center;">Standard</th>';
    html += '<th style="padding: 10px; text-align: center;">Verwendet</th>';
    html += '<th style="padding: 10px; text-align: right;">Aktionen</th>';
    html += '</tr></thead><tbody>';

    prompts.forEach(function(prompt) {
        html += '<tr style="border-bottom: 1px solid #ddd;">';
        html += '<td style="padding: 10px;"><strong>' + escapeHtml(prompt.prompt_label) + '</strong></td>';
        html += '<td style="padding: 10px;">' + (prompt.prompt_description ? escapeHtml(prompt.prompt_description) : '<em style="color: #999;">-</em>') + '</td>';
        html += '<td style="padding: 10px; text-align: center;">' + (prompt.is_default == 1 ? '‚≠ê Ja' : '-') + '</td>';
        html += '<td style="padding: 10px; text-align: center;">' + (prompt.usage_count || 0) + 'x</td>';
        html += '<td style="padding: 10px; text-align: right;">';
        html += '<button class="btn btn-info btn-sm" style="padding: 5px 10px; margin: 2px;" onclick="loadPromptIntoForm(' + prompt.prompt_id + ')">üì• Laden</button> ';
        html += '<button class="btn btn-secondary btn-sm" style="padding: 5px 10px; margin: 2px;" onclick="editPrompt(' + prompt.prompt_id + ')">‚úèÔ∏è Bearbeiten</button> ';
        if (prompt.is_default != 1) {
            html += '<button class="btn btn-info btn-sm" style="padding: 5px 10px; margin: 2px;" onclick="setDefaultPrompt(' + prompt.prompt_id + ')">‚≠ê Als Standard</button> ';
        }
        html += '<button class="btn btn-secondary btn-sm" style="padding: 5px 10px; margin: 2px; background: #dc3545;" onclick="deletePrompt(' + prompt.prompt_id + ')">üóëÔ∏è L√∂schen</button>';
        html += '</td>';
        html += '</tr>';
    });

    html += '</tbody></table>';
    listEl.innerHTML = html;
}

function showAddPromptDialog(promptType) {
    // Kopiere aktuelle Werte aus dem Formular
    if (promptType === 'vision') {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="vision_system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="vision_user_prompt"]').value;
    } else {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="user_prompt"]').value;
    }
    document.getElementById('new-prompt-label').value = '';
    document.getElementById('new-prompt-description').value = '';
    document.getElementById('new-prompt-default').checked = false;
    document.getElementById('save-prompt-status').innerHTML = '';
    // Speichere prompt_type in hidden field oder data-attribute
    document.getElementById('add-prompt-modal').setAttribute('data-prompt-type', promptType || 'product');
    document.getElementById('add-prompt-modal').style.display = 'block';
}

function hideAddPromptDialog() {
    document.getElementById('add-prompt-modal').style.display = 'none';
}

function saveNewPrompt() {
    var label = document.getElementById('new-prompt-label').value;
    var description = document.getElementById('new-prompt-description').value;
    var systemPrompt = document.getElementById('new-prompt-system').value;
    var userPrompt = document.getElementById('new-prompt-user').value;
    var isDefault = document.getElementById('new-prompt-default').checked ? '1' : '0';
    var promptType = document.getElementById('add-prompt-modal').getAttribute('data-prompt-type') || 'product';
    var statusEl = document.getElementById('save-prompt-status');

    if (!label || !systemPrompt || !userPrompt) {
        statusEl.innerHTML = '‚ùå Bitte alle Pflichtfelder ausf√ºllen';
        statusEl.style.color = '#dc3545';
        return;
    }

    statusEl.innerHTML = '‚è≥ Speichert Prompt...';
    statusEl.style.color = '#666';

    var formData = new FormData();
    formData.append('label', label);
    formData.append('description', description);
    formData.append('system_prompt', systemPrompt);
    formData.append('user_prompt', userPrompt);
    formData.append('is_default', isDefault);
    formData.append('prompt_type', promptType);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/CreatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.innerHTML = '‚úì Prompt erfolgreich gespeichert!';
            statusEl.style.color = '#28a745';
            setTimeout(() => {
                hideAddPromptDialog();
                // Reload the appropriate library modal if it's open
                if (document.getElementById('product-library-modal').style.display === 'block') {
                    loadPromptLibraryInto('product', 'product-library-list');
                } else if (document.getElementById('vision-library-modal').style.display === 'block') {
                    loadPromptLibraryInto('vision', 'vision-library-list');
                }
            }, 1500);
        } else {
            statusEl.innerHTML = '‚ùå Fehler: ' + data.error;
            statusEl.style.color = '#dc3545';
        }
    })
    .catch(error => {
        statusEl.innerHTML = '‚ùå Fehler: ' + error.message;
        statusEl.style.color = '#dc3545';
    });
}

function loadPromptIntoForm(promptId) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompt&prompt_id=' + promptId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompt;
            document.querySelector('textarea[name="system_prompt"]').value = prompt.system_prompt;
            document.querySelector('textarea[name="user_prompt"]').value = prompt.user_prompt;
            alert('‚úì Prompt "' + prompt.prompt_label + '" wurde in das Formular geladen. Vergessen Sie nicht zu speichern!');
            window.scrollTo(0, 0);
        } else {
            alert('‚ùå Fehler: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler: ' + error.message);
    });
}

function editPrompt(promptId) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompt&prompt_id=' + promptId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompt;
            document.getElementById('edit-prompt-id').value = prompt.prompt_id;
            document.getElementById('edit-prompt-label').value = prompt.prompt_label;
            document.getElementById('edit-prompt-description').value = prompt.prompt_description || '';
            document.getElementById('edit-prompt-system').value = prompt.system_prompt;
            document.getElementById('edit-prompt-user').value = prompt.user_prompt;
            document.getElementById('edit-prompt-default').checked = prompt.is_default == 1;
            document.getElementById('edit-prompt-active').checked = prompt.is_active == 1;
            document.getElementById('edit-prompt-status').innerHTML = '';
            document.getElementById('edit-prompt-modal').style.display = 'block';
        } else {
            alert('‚ùå Fehler: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler: ' + error.message);
    });
}

function hideEditPromptDialog() {
    document.getElementById('edit-prompt-modal').style.display = 'none';
}

function saveEditedPrompt() {
    var promptId = document.getElementById('edit-prompt-id').value;
    var label = document.getElementById('edit-prompt-label').value;
    var description = document.getElementById('edit-prompt-description').value;
    var systemPrompt = document.getElementById('edit-prompt-system').value;
    var userPrompt = document.getElementById('edit-prompt-user').value;
    var isDefault = document.getElementById('edit-prompt-default').checked ? '1' : '0';
    var isActive = document.getElementById('edit-prompt-active').checked ? '1' : '0';
    var statusEl = document.getElementById('edit-prompt-status');

    if (!label || !systemPrompt || !userPrompt) {
        statusEl.innerHTML = '‚ùå Bitte alle Pflichtfelder ausf√ºllen';
        statusEl.style.color = '#dc3545';
        return;
    }

    statusEl.innerHTML = '‚è≥ Speichert √Ñnderungen...';
    statusEl.style.color = '#666';

    var formData = new FormData();
    formData.append('prompt_id', promptId);
    formData.append('label', label);
    formData.append('description', description);
    formData.append('system_prompt', systemPrompt);
    formData.append('user_prompt', userPrompt);
    formData.append('is_default', isDefault);
    formData.append('is_active', isActive);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.innerHTML = '‚úì √Ñnderungen erfolgreich gespeichert!';
            statusEl.style.color = '#28a745';
            setTimeout(() => {
                hideEditPromptDialog();
                // Reload the appropriate library modal if it's open
                if (document.getElementById('product-library-modal').style.display === 'block') {
                    loadPromptLibraryInto('product', 'product-library-list');
                } else if (document.getElementById('vision-library-modal').style.display === 'block') {
                    loadPromptLibraryInto('vision', 'vision-library-list');
                }
            }, 1500);
        } else {
            statusEl.innerHTML = '‚ùå Fehler: ' + data.error;
            statusEl.style.color = '#dc3545';
        }
    })
    .catch(error => {
        statusEl.innerHTML = '‚ùå Fehler: ' + error.message;
        statusEl.style.color = '#dc3545';
    });
}

function deletePrompt(promptId) {
    if (!confirm('M√∂chten Sie diesen Prompt wirklich l√∂schen?')) {
        return;
    }

    // Use URLSearchParams instead of FormData for better Gambio compatibility
    var params = new URLSearchParams();
    params.append('prompt_id', promptId);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/DeletePrompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params.toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Prompt erfolgreich gel√∂scht');
            loadPromptLibrary();
        } else {
            alert('‚ùå Fehler: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('‚ùå Fehler: ' + error.message);
    });
}

function setDefaultPrompt(promptId) {
    if (!confirm('M√∂chten Sie diesen Prompt als Standard setzen?')) {
        return;
    }

    var formData = new FormData();
    formData.append('prompt_id', promptId);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/SetDefaultPrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úì Standard-Prompt erfolgreich gesetzt');
            loadPromptLibrary();
        } else {
            alert('‚ùå Fehler: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler: ' + error.message);
    });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================
// Separate Library Functions for Product and Vision
// ============================================================

function showProductPromptLibrary() {
    document.getElementById('product-library-modal').style.display = 'block';
    loadPromptLibraryInto('product', 'product-library-list');
}

function hideProductLibrary() {
    document.getElementById('product-library-modal').style.display = 'none';
}

function showVisionPromptLibrary() {
    document.getElementById('vision-library-modal').style.display = 'block';
    loadPromptLibraryInto('vision', 'vision-library-list');
}

function hideVisionLibrary() {
    document.getElementById('vision-library-modal').style.display = 'none';
}

function loadPromptLibraryInto(promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);
    listEl.innerHTML = '<p style="color: #666;">‚è≥ Lade Prompts...</p>';

    var url = 'admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=1';
    if (promptType) {
        url += '&prompt_type=' + promptType;
    }

    fetch(url)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPromptLibraryInto(data.prompts, promptType, targetElementId);
        } else {
            listEl.innerHTML = '<p style="color: #dc3545;">‚ùå Fehler: ' + data.error + '</p>';
        }
    })
    .catch(error => {
        listEl.innerHTML = '<p style="color: #dc3545;">‚ùå Fehler: ' + error.message + '</p>';
    });
}

function displayPromptLibraryInto(prompts, promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);

    if (!prompts || prompts.length === 0) {
        var typeLabel = promptType === 'vision' ? 'ALT-Text' : 'Produkttext';
        listEl.innerHTML = '<div style="padding: 20px; background: #f8f9fa; border-radius: 4px; text-align: center;">' +
            '<p style="color: #666; margin: 0;">Noch keine ' + typeLabel + '-Prompts gespeichert.</p>' +
            '<p style="color: #999; margin: 10px 0 0 0; font-size: 0.9em;">Klicken Sie auf "‚ûï Neuen Prompt erstellen" um einen Prompt zu speichern.</p>' +
            '</div>';
        return;
    }

    var html = '<table class="table table-striped" style="margin-top: 20px;">';
    html += '<thead><tr>';
    html += '<th>Label</th>';
    html += '<th>Beschreibung</th>';
    html += '<th>Erstellt</th>';
    html += '<th>Standard</th>';
    html += '<th>Verwendet</th>';
    html += '<th>Aktionen</th>';
    html += '</tr></thead><tbody>';

    prompts.forEach(function(prompt) {
        html += '<tr' + (prompt.is_default ? ' style="background-color: #e7f3ff;"' : '') + '>';
        html += '<td><strong>' + escapeHtml(prompt.prompt_label) + '</strong></td>';
        html += '<td>' + (prompt.prompt_description ? escapeHtml(prompt.prompt_description) : '<em style="color: #999;">-</em>') + '</td>';
        html += '<td>' + prompt.created_at + '</td>';
        html += '<td>' + (prompt.is_default ? '‚≠ê Ja' : '-') + '</td>';
        html += '<td>' + prompt.usage_count + 'x</td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-info" onclick="loadPromptToForm(' + prompt.prompt_id + ', \'' + promptType + '\')">üìã Laden</button> ';
        html += '<button class="btn btn-sm btn-primary" onclick="editPrompt(' + prompt.prompt_id + ')">‚úèÔ∏è</button> ';
        html += '<button class="btn btn-sm btn-danger" onclick="deletePromptAndReload(' + prompt.prompt_id + ', \'' + promptType + '\', \'' + targetElementId + '\')">üóëÔ∏è</button>';
        html += '</td>';
        html += '</tr>';
    });

    html += '</tbody></table>';
    listEl.innerHTML = html;
}

function loadPromptToForm(promptId, promptType) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=0')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompts.find(p => p.prompt_id == promptId);
            if (prompt) {
                if (promptType === 'vision') {
                    document.querySelector('textarea[name="vision_system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="vision_user_prompt"]').value = prompt.user_prompt;
                    hideVisionLibrary();
                    alert('‚úì Vision-Prompts in Formular geladen.\n\nVergessen Sie nicht auf "Speichern" zu klicken!');
                } else {
                    document.querySelector('textarea[name="system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="user_prompt"]').value = prompt.user_prompt;
                    hideProductLibrary();
                    alert('‚úì Produkttext-Prompts in Formular geladen.\n\nVergessen Sie nicht auf "Speichern" zu klicken!');
                }
            }
        }
    })
    .catch(error => {
        alert('‚ùå Fehler beim Laden: ' + error.message);
    });
}

function deletePromptAndReload(promptId, promptType, targetElementId) {
    if (!confirm('M√∂chten Sie diesen Prompt wirklich l√∂schen?')) {
        return;
    }

    var params = new URLSearchParams();
    params.append('prompt_id', promptId);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/DeletePrompt', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params.toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the specific library
            loadPromptLibraryInto(promptType, targetElementId);
        } else {
            alert('‚ùå Fehler: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Fehler: ' + error.message);
    });
}
</script>
</body>
</html>
