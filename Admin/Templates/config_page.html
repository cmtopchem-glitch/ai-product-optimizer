<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        .ai-config-container {
            max-width: 100%;
            padding: 20px;
            background: #fff;
        }

        /* Simple Tab Navigation */
        .simple-tabs {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            border-bottom: 2px solid #ddd;
            display: flex;
        }

        .simple-tabs li {
            margin-right: 5px;
        }

        .simple-tabs a {
            display: block;
            padding: 12px 20px;
            text-decoration: none;
            color: #555;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }

        .simple-tabs a:hover {
            background: #e9e9e9;
        }

        .simple-tabs a.active {
            background: #fff;
            color: #000;
            font-weight: bold;
            border-bottom: 2px solid #fff;
            margin-bottom: -2px;
        }

        /* Tab Content */
        .tab-content-pane {
            display: none;
            padding: 20px 0;
        }

        .tab-content-pane.active {
            display: block;
        }

        /* Alert Styles */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid transparent;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            max-width: 800px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea.form-control {
            min-height: 150px;
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }

        .help-block {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-default {
            background: #f8f9fa;
            color: #333;
        }

        .btn-default:hover {
            background: #e2e6ea;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Info Box */
        .placeholder-info {
            background: #f8f9fa;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #007bff;
            font-size: 13px;
        }

        .placeholder-info code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Library Section */
        .library-section {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin-top: 30px;
            border-radius: 4px;
        }

        .library-section h4 {
            margin-top: 0;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }

        .modal-content-wrapper {
            background: white;
            max-width: 1000px;
            margin: 30px auto;
            padding: 30px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin-bottom: 20px;
        }

        /* Table */
        .library-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .library-table thead tr {
            background: #f8f9fa;
        }

        .library-table th,
        .library-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        /* Icon Spacing */
        .fa {
            margin-right: 5px;
        }
    </style>
</head>
<body>
<div class="ai-config-container">
    <h1 style="margin-bottom: 20px;">
        <i class="fa fa-robot"></i> AI Product Optimizer - Konfiguration
    </h1>

    {if $success}
    <div class="alert alert-success">
        <i class="fa fa-check-circle"></i> Konfiguration erfolgreich gespeichert!
    </div>
    {/if}

    {if $error}
    <div class="alert alert-danger">
        <i class="fa fa-exclamation-circle"></i> Bitte API Key eingeben!
    </div>
    {/if}

    {if $backupWarning}
    <div class="alert alert-warning">
        <h3 style="margin-top: 0;"><i class="fa fa-exclamation-triangle"></i> WARNUNG: Backup-Verzeichnisse gefunden!</h3>
        <p><strong>{$backupWarning.message}</strong></p>
        <div style="margin: 15px 0; padding: 10px; background: #fffbf0; border-left: 4px solid #ff9800;">
            <p><strong>Gefundene Backup-Verzeichnisse ({$backupWarning.count}):</strong></p>
            <ul>
                {foreach from=$backupWarning.directories item=dir}
                <li><code>{$dir.name}</code> ({$dir.size})</li>
                {/foreach}
            </ul>
        </div>
        <p><strong>WICHTIG:</strong> Verschieben Sie diese Verzeichnisse außerhalb von <code>GXModules/</code>!</p>
    </div>
    {/if}

    <form action="admin.php?do=AIProductOptimizerModuleCenterModule/Save" method="post">

        <!-- Simple Tab Navigation -->
        <ul class="simple-tabs">
            <li><a href="#" onclick="switchTab(event, 'tab-general')" class="active"><i class="fa fa-cog"></i> Grundeinstellungen</a></li>
            <li><a href="#" onclick="switchTab(event, 'tab-product-prompts')"><i class="fa fa-file-text"></i> Produkt Prompts</a></li>
            <li><a href="#" onclick="switchTab(event, 'tab-vision-prompts')"><i class="fa fa-image"></i> Bilder Prompts</a></li>
        </ul>

        <!-- Tab 1: Grundeinstellungen -->
        <div id="tab-general" class="tab-content-pane active">
            <h2><i class="fa fa-key"></i> API-Einstellungen</h2>

            <div class="form-group">
                <label>OpenAI API Key *</label>
                <input type="text" class="form-control" name="openai_key" value="{$apiKey|escape}" required>
                <p class="help-block">API Key von <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>
            </div>

            <div class="form-group">
                <label>OpenAI Project ID (optional)</label>
                <input type="text" class="form-control" name="project_id" value="{$projectId|escape}" placeholder="proj_...">
                <p class="help-block">Project ID für OpenAI Project-Keys. Format: proj_xxxxxxxxxx</p>
            </div>

            <div class="form-group">
                <label>Modell für Produkttexte</label>
                <select class="form-control" name="model">
                    {if $availableModels && count($availableModels) > 0}
                        {foreach from=$availableModels item=modelOption}
                            <option value="{$modelOption.id}" {if $model == $modelOption.id}selected{/if}>{$modelOption.name}</option>
                        {/foreach}
                    {else}
                        <option value="gpt-4o-mini" {if $model == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (empfohlen, günstig)</option>
                        <option value="gpt-4o" {if $model == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualität)</option>
                    {/if}
                </select>
            </div>

            <div class="form-group">
                <label>Modell für Bilderkennung (ALT-Texte)</label>
                <select class="form-control" name="vision_model">
                    <option value="gpt-4o" {if $visionModel == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualität, empfohlen)</option>
                    <option value="gpt-4o-mini" {if $visionModel == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (schneller, günstiger)</option>
                </select>
            </div>

            <div class="form-group">
                <button type="button" class="btn btn-default" onclick="updateModels()">
                    <i class="fa fa-refresh"></i> Modelle von OpenAI aktualisieren
                </button>
                <p class="help-block" id="update-status"></p>
            </div>

            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                <h3><i class="fa fa-info-circle"></i> Verwendung</h3>
                <ol>
                    <li>Konfigurieren Sie Ihren OpenAI API Key und wählen Sie ein Modell</li>
                    <li>Passen Sie optional die Prompts in den anderen Tabs an</li>
                    <li>Öffnen Sie ein Produkt in der Artikelverwaltung</li>
                    <li>Klicken Sie auf "SEO-Texte mit KI generieren"</li>
                </ol>
            </div>
        </div>

        <!-- Tab 2: Produkt Prompts -->
        <div id="tab-product-prompts" class="tab-content-pane">
            <h2><i class="fa fa-file-text"></i> Prompt-Konfiguration für Produkttexte</h2>

            <div class="form-group">
                <label>System-Prompt</label>
                <textarea class="form-control" name="system_prompt" rows="4">{$systemPrompt|escape}</textarea>
                <p class="help-block">Definiert die Rolle und das grundsätzliche Verhalten der KI</p>
                <button type="button" class="btn btn-default btn-sm" onclick="resetSystemPrompt()">
                    <i class="fa fa-undo"></i> Standard wiederherstellen
                </button>
            </div>

            <div class="form-group">
                <label>User-Prompt (Aufgabenstellung)</label>
                <textarea class="form-control" name="user_prompt" rows="20">{$userPrompt|escape}</textarea>
                <div class="placeholder-info">
                    <strong>Verfügbare Platzhalter:</strong><br>
                    <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                    <code>{literal}{ldelim}ORIGINAL_TEXT{rdelim}{/literal}</code> - Original Produktbeschreibung<br>
                    <code>{literal}{ldelim}LANGUAGE{rdelim}{/literal}</code> - Zielsprache<br>
                    <code>{literal}{ldelim}BRAND_LINE{rdelim}{/literal}</code> - Marke<br>
                    <code>{literal}{ldelim}CATEGORY_LINE{rdelim}{/literal}</code> - Kategorie
                </div>
                <button type="button" class="btn btn-default btn-sm" onclick="resetUserPrompt()">
                    <i class="fa fa-undo"></i> Standard wiederherstellen
                </button>
            </div>

            <div class="library-section">
                <h4><i class="fa fa-book"></i> Prompt-Bibliothek für Produkttexte</h4>
                <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen.</p>
                <button type="button" class="btn btn-primary" onclick="showProductPromptLibrary()">
                    <i class="fa fa-book"></i> Bibliothek öffnen
                </button>
            </div>
        </div>

        <!-- Tab 3: Vision Prompts -->
        <div id="tab-vision-prompts" class="tab-content-pane">
            <h2><i class="fa fa-image"></i> Prompt-Konfiguration für ALT-Texte</h2>

            <div class="form-group">
                <label>System-Prompt für ALT-Texte</label>
                <textarea class="form-control" name="vision_system_prompt" rows="4">{$visionSystemPrompt|escape}</textarea>
                <p class="help-block">Definiert die Rolle für barrierefreie Bildbeschreibungen</p>
                <button type="button" class="btn btn-default btn-sm" onclick="resetVisionSystemPrompt()">
                    <i class="fa fa-undo"></i> Standard wiederherstellen
                </button>
            </div>

            <div class="form-group">
                <label>User-Prompt für ALT-Texte</label>
                <textarea class="form-control" name="vision_user_prompt" rows="15">{$visionUserPrompt|escape}</textarea>
                <div class="placeholder-info">
                    <strong>Verfügbare Platzhalter:</strong><br>
                    <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                    <code>{literal}{ldelim}LANGUAGES{rdelim}{/literal}</code> - Liste der gewünschten Sprachen
                </div>
                <button type="button" class="btn btn-default btn-sm" onclick="resetVisionUserPrompt()">
                    <i class="fa fa-undo"></i> Standard wiederherstellen
                </button>
            </div>

            <div class="library-section" style="border-left-color: #17a2b8;">
                <h4><i class="fa fa-book"></i> Prompt-Bibliothek für ALT-Texte</h4>
                <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen.</p>
                <button type="button" class="btn btn-info" onclick="showVisionPromptLibrary()">
                    <i class="fa fa-book"></i> Bibliothek öffnen
                </button>
            </div>
        </div>

        <!-- Form Actions -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-save"></i> Einstellungen speichern
            </button>
            <a href="admin.php?do=ModuleCenter" class="btn btn-default">
                <i class="fa fa-arrow-left"></i> Zurück zum Modulcenter
            </a>
        </div>
    </form>

    <!-- Modals (same as before) -->
    <div id="add-prompt-modal" class="modal-overlay">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h3><i class="fa fa-plus-circle"></i> Neuen Prompt speichern</h3>
            </div>
            <div class="form-group">
                <label>Label/Name *</label>
                <input type="text" class="form-control" id="new-prompt-label">
            </div>
            <div class="form-group">
                <label>Beschreibung</label>
                <textarea class="form-control" id="new-prompt-description" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>System-Prompt *</label>
                <textarea class="form-control" id="new-prompt-system" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>User-Prompt *</label>
                <textarea class="form-control" id="new-prompt-user" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="new-prompt-default"> Als Standard-Prompt setzen</label>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveNewPrompt()">
                <i class="fa fa-save"></i> Prompt speichern
            </button>
            <button type="button" class="btn btn-default" onclick="hideAddPromptDialog()">Abbrechen</button>
            <p id="save-prompt-status" class="help-block"></p>
        </div>
    </div>

    <div id="edit-prompt-modal" class="modal-overlay">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h3><i class="fa fa-edit"></i> Prompt bearbeiten</h3>
            </div>
            <input type="hidden" id="edit-prompt-id">
            <div class="form-group">
                <label>Label/Name *</label>
                <input type="text" class="form-control" id="edit-prompt-label">
            </div>
            <div class="form-group">
                <label>Beschreibung</label>
                <textarea class="form-control" id="edit-prompt-description" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>System-Prompt *</label>
                <textarea class="form-control" id="edit-prompt-system" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>User-Prompt *</label>
                <textarea class="form-control" id="edit-prompt-user" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="edit-prompt-default"> Als Standard-Prompt setzen</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="edit-prompt-active" checked> Aktiv</label>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveEditedPrompt()">
                <i class="fa fa-save"></i> Änderungen speichern
            </button>
            <button type="button" class="btn btn-default" onclick="hideEditPromptDialog()">Abbrechen</button>
            <p id="edit-prompt-status" class="help-block"></p>
        </div>
    </div>

    <div id="product-library-modal" class="modal-overlay" onclick="if(event.target.id==='product-library-modal') hideProductLibrary();">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h3><i class="fa fa-book"></i> Prompt-Bibliothek für Produkttexte</h3>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="showAddPromptDialog('product')">
                    <i class="fa fa-plus"></i> Neuen Prompt erstellen
                </button>
                <button type="button" class="btn btn-default" style="float: right;" onclick="hideProductLibrary()">
                    <i class="fa fa-times"></i> Schließen
                </button>
            </div>
            <div id="product-library-list"></div>
        </div>
    </div>

    <div id="vision-library-modal" class="modal-overlay" onclick="if(event.target.id==='vision-library-modal') hideVisionLibrary();">
        <div class="modal-content-wrapper">
            <div class="modal-header">
                <h3><i class="fa fa-book"></i> Prompt-Bibliothek für ALT-Texte</h3>
            </div>
            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="showAddPromptDialog('vision')">
                    <i class="fa fa-plus"></i> Neuen Prompt erstellen
                </button>
                <button type="button" class="btn btn-default" style="float: right;" onclick="hideVisionLibrary()">
                    <i class="fa fa-times"></i> Schließen
                </button>
            </div>
            <div id="vision-library-list"></div>
        </div>
    </div>
</div>

<script>
// Tab Switching
function switchTab(event, tabId) {
    event.preventDefault();

    // Hide all tabs
    var tabs = document.querySelectorAll('.tab-content-pane');
    tabs.forEach(function(tab) {
        tab.classList.remove('active');
    });

    // Remove active from all tab links
    var links = document.querySelectorAll('.simple-tabs a');
    links.forEach(function(link) {
        link.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// Default Prompts
var defaultSystemPrompt = 'Du bist ein professioneller E-Commerce SEO-Texter. Du antwortest immer im angeforderten JSON-Format.';
var defaultUserPrompt = `Du bist ein Experte für E-Commerce SEO und Produkttexte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}
{ldelim}BRAND_LINE{rdelim}{ldelim}CATEGORY_LINE{rdelim}
Original-Produkttext:
{ldelim}ORIGINAL_TEXT{rdelim}

AUFGABE:
Erstelle einen SEO-optimierten Produkttext in {ldelim}LANGUAGE{rdelim}.

FORMAT DER ANTWORT (JSON):
{
  "product_description": "Der optimierte Produkttext hier...",
  "meta_title": "SEO Meta-Titel",
  "meta_description": "SEO Meta-Description"
}

Antworte NUR mit dem JSON-Objekt, ohne zusätzlichen Text.`;

var defaultVisionSystemPrompt = 'Du bist ein Experte für barrierefreie Bildbeschreibungen.';
var defaultVisionUserPrompt = `Analysiere dieses Produktbild und erstelle barrierefreie ALT-Texte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}

Erstelle ALT-Texte für folgende Sprachen:
{ldelim}LANGUAGES{rdelim}

Antworte NUR mit einem JSON-Objekt in diesem Format:
{
  "de": "ALT-Text in Deutsch",
  "en": "ALT-text in English"
}`;

function resetSystemPrompt() {
    if (confirm('System-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="system_prompt"]').value = defaultSystemPrompt;
    }
}

function resetUserPrompt() {
    if (confirm('User-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="user_prompt"]').value = defaultUserPrompt;
    }
}

function resetVisionSystemPrompt() {
    if (confirm('Vision System-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="vision_system_prompt"]').value = defaultVisionSystemPrompt;
    }
}

function resetVisionUserPrompt() {
    if (confirm('Vision User-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="vision_user_prompt"]').value = defaultVisionUserPrompt;
    }
}

function updateModels() {
    var statusEl = document.getElementById('update-status');
    statusEl.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Lade Modelle...';
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdateModels', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.innerHTML = '<i class="fa fa-check"></i> ' + data.count + ' Modelle aktualisiert. Seite wird neu geladen...';
            setTimeout(() => location.reload(), 1500);
        } else {
            statusEl.innerHTML = '<i class="fa fa-times"></i> Fehler: ' + data.error;
        }
    });
}

// Prompt Library Functions
function showProductPromptLibrary() {
    document.getElementById('product-library-modal').style.display = 'block';
    loadPromptLibraryInto('product', 'product-library-list');
}

function hideProductLibrary() {
    document.getElementById('product-library-modal').style.display = 'none';
}

function showVisionPromptLibrary() {
    document.getElementById('vision-library-modal').style.display = 'block';
    loadPromptLibraryInto('vision', 'vision-library-list');
}

function hideVisionLibrary() {
    document.getElementById('vision-library-modal').style.display = 'none';
}

function loadPromptLibraryInto(promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);
    listEl.innerHTML = '<p><i class="fa fa-spinner fa-spin"></i> Lade Prompts...</p>';

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=1&prompt_type=' + promptType)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPromptLibraryInto(data.prompts, promptType, targetElementId);
        } else {
            listEl.innerHTML = '<p>Fehler: ' + data.error + '</p>';
        }
    });
}

function displayPromptLibraryInto(prompts, promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);
    if (!prompts || prompts.length === 0) {
        listEl.innerHTML = '<p>Noch keine Prompts gespeichert.</p>';
        return;
    }

    var html = '<table class="library-table"><thead><tr><th>Label</th><th>Beschreibung</th><th>Standard</th><th>Aktionen</th></tr></thead><tbody>';
    prompts.forEach(function(prompt) {
        html += '<tr>';
        html += '<td><strong>' + escapeHtml(prompt.prompt_label) + '</strong></td>';
        html += '<td>' + (prompt.prompt_description || '-') + '</td>';
        html += '<td>' + (prompt.is_default ? '<i class="fa fa-star"></i>' : '-') + '</td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-info" onclick="loadPromptToForm(' + prompt.prompt_id + ', \'' + promptType + '\')">Laden</button> ';
        html += '<button class="btn btn-sm btn-default" onclick="editPrompt(' + prompt.prompt_id + ')">Bearbeiten</button> ';
        html += '<button class="btn btn-sm btn-danger" onclick="deletePromptAndReload(' + prompt.prompt_id + ', \'' + promptType + '\', \'' + targetElementId + '\')">Löschen</button>';
        html += '</td>';
        html += '</tr>';
    });
    html += '</tbody></table>';
    listEl.innerHTML = html;
}

function loadPromptToForm(promptId, promptType) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=0')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompts.find(p => p.prompt_id == promptId);
            if (prompt) {
                if (promptType === 'vision') {
                    document.querySelector('textarea[name="vision_system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="vision_user_prompt"]').value = prompt.user_prompt;
                    hideVisionLibrary();
                } else {
                    document.querySelector('textarea[name="system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="user_prompt"]').value = prompt.user_prompt;
                    hideProductLibrary();
                }
                alert('Prompts geladen. Vergessen Sie nicht zu speichern!');
            }
        }
    });
}

function showAddPromptDialog(promptType) {
    if (promptType === 'vision') {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="vision_system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="vision_user_prompt"]').value;
    } else {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="user_prompt"]').value;
    }
    document.getElementById('new-prompt-label').value = '';
    document.getElementById('new-prompt-description').value = '';
    document.getElementById('new-prompt-default').checked = false;
    document.getElementById('add-prompt-modal').setAttribute('data-prompt-type', promptType || 'product');
    document.getElementById('add-prompt-modal').style.display = 'block';
}

function hideAddPromptDialog() {
    document.getElementById('add-prompt-modal').style.display = 'none';
}

function saveNewPrompt() {
    var label = document.getElementById('new-prompt-label').value;
    var formData = new FormData();
    formData.append('label', label);
    formData.append('description', document.getElementById('new-prompt-description').value);
    formData.append('system_prompt', document.getElementById('new-prompt-system').value);
    formData.append('user_prompt', document.getElementById('new-prompt-user').value);
    formData.append('is_default', document.getElementById('new-prompt-default').checked ? '1' : '0');
    formData.append('prompt_type', document.getElementById('add-prompt-modal').getAttribute('data-prompt-type'));

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/CreatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Prompt gespeichert!');
            hideAddPromptDialog();
            if (document.getElementById('product-library-modal').style.display === 'block') {
                loadPromptLibraryInto('product', 'product-library-list');
            } else {
                loadPromptLibraryInto('vision', 'vision-library-list');
            }
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

function editPrompt(promptId) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompt&prompt_id=' + promptId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompt;
            document.getElementById('edit-prompt-id').value = prompt.prompt_id;
            document.getElementById('edit-prompt-label').value = prompt.prompt_label;
            document.getElementById('edit-prompt-description').value = prompt.prompt_description || '';
            document.getElementById('edit-prompt-system').value = prompt.system_prompt;
            document.getElementById('edit-prompt-user').value = prompt.user_prompt;
            document.getElementById('edit-prompt-default').checked = prompt.is_default == 1;
            document.getElementById('edit-prompt-active').checked = prompt.is_active == 1;
            document.getElementById('edit-prompt-modal').style.display = 'block';
        }
    });
}

function hideEditPromptDialog() {
    document.getElementById('edit-prompt-modal').style.display = 'none';
}

function saveEditedPrompt() {
    var formData = new FormData();
    formData.append('prompt_id', document.getElementById('edit-prompt-id').value);
    formData.append('label', document.getElementById('edit-prompt-label').value);
    formData.append('description', document.getElementById('edit-prompt-description').value);
    formData.append('system_prompt', document.getElementById('edit-prompt-system').value);
    formData.append('user_prompt', document.getElementById('edit-prompt-user').value);
    formData.append('is_default', document.getElementById('edit-prompt-default').checked ? '1' : '0');
    formData.append('is_active', document.getElementById('edit-prompt-active').checked ? '1' : '0');

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Änderungen gespeichert!');
            hideEditPromptDialog();
            if (document.getElementById('product-library-modal').style.display === 'block') {
                loadPromptLibraryInto('product', 'product-library-list');
            } else {
                loadPromptLibraryInto('vision', 'vision-library-list');
            }
        }
    });
}

function deletePromptAndReload(promptId, promptType, targetElementId) {
    if (!confirm('Prompt wirklich löschen?')) return;

    var params = new URLSearchParams();
    params.append('prompt_id', promptId);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/DeletePrompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadPromptLibraryInto(promptType, targetElementId);
        }
    });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>
