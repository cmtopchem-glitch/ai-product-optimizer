<div class="ai-product-optimizer-config">
    <style>
        /* Minimal custom styles for inline ModuleCenter display */
        .ai-product-optimizer-config {
            padding: 20px 0;
        }

        .ai-product-optimizer-config .tab-content {
            padding-top: 20px;
        }

        /* Ensure tabs work properly */
        .ai-product-optimizer-config .tab-pane {
            display: none;
        }

        .ai-product-optimizer-config .tab-pane.active {
            display: block;
        }

        .ai-product-optimizer-config .nav-tabs {
            margin-bottom: 20px;
        }

        .ai-product-optimizer-config textarea.form-control {
            font-family: monospace;
            font-size: 13px;
            min-height: 150px;
        }

        .ai-product-optimizer-config .placeholder-info {
            background: #f5f5f5;
            padding: 10px;
            margin-top: 10px;
            border-left: 3px solid #337ab7;
            font-size: 13px;
        }

        .ai-product-optimizer-config .placeholder-info code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .ai-product-optimizer-config .library-section {
            background: #f5f5f5;
            padding: 15px;
            border-left: 4px solid #337ab7;
            margin-top: 30px;
            border-radius: 4px;
        }

        .ai-product-optimizer-config .library-section h4 {
            margin-top: 0;
        }

        .ai-product-optimizer-config .library-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ai-product-optimizer-config .library-table thead tr {
            background: #f5f5f5;
        }

        .ai-product-optimizer-config .library-table th,
        .ai-product-optimizer-config .library-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .ai-product-optimizer-config .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>

    <h2>
        <i class="fa fa-robot"></i> AI Product Optimizer - Konfiguration
    </h2>

    {if $success}
    <div class="alert alert-success">
        <i class="fa fa-check-circle"></i> Konfiguration erfolgreich gespeichert!
    </div>
    {/if}

    {if $error}
    <div class="alert alert-danger">
        <i class="fa fa-exclamation-circle"></i> Bitte API Key eingeben!
    </div>
    {/if}

    {if $backupWarning}
    <div class="alert alert-warning">
        <h4><i class="fa fa-exclamation-triangle"></i> WARNUNG: Backup-Verzeichnisse gefunden!</h4>
        <p><strong>{$backupWarning.message}</strong></p>
        <div style="margin: 15px 0; padding: 10px; background: #fffbf0; border-left: 4px solid #ff9800;">
            <p><strong>Gefundene Backup-Verzeichnisse ({$backupWarning.count}):</strong></p>
            <ul>
                {foreach from=$backupWarning.directories item=dir}
                <li><code>{$dir.name}</code> ({$dir.size})</li>
                {/foreach}
            </ul>
        </div>
        <p><strong>WICHTIG:</strong> Verschieben Sie diese Verzeichnisse außerhalb von <code>GXModules/</code>!</p>
    </div>
    {/if}

    <form action="admin.php?do=AIProductOptimizerModuleCenterModule/Save" method="post" class="form-horizontal">

        <!-- Bootstrap 3 Tab Navigation -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#tab-general" aria-controls="tab-general" role="tab" data-toggle="tab">
                    <i class="fa fa-cog"></i> Grundeinstellungen
                </a>
            </li>
            <li role="presentation">
                <a href="#tab-product-prompts" aria-controls="tab-product-prompts" role="tab" data-toggle="tab">
                    <i class="fa fa-file-text"></i> Produkt Prompts
                </a>
            </li>
            <li role="presentation">
                <a href="#tab-vision-prompts" aria-controls="tab-vision-prompts" role="tab" data-toggle="tab">
                    <i class="fa fa-image"></i> Bilder Prompts
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">

            <!-- Tab 1: Grundeinstellungen -->
            <div role="tabpanel" class="tab-pane active" id="tab-general">
                <h3><i class="fa fa-key"></i> API-Einstellungen</h3>

                <div class="form-group">
                    <label class="col-sm-3 control-label">OpenAI API Key *</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" name="openai_key" value="{$apiKey|escape}" required>
                        <p class="help-block">API Key von <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">OpenAI Project ID (optional)</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" name="project_id" value="{$projectId|escape}" placeholder="proj_...">
                        <p class="help-block">Project ID für OpenAI Project-Keys. Format: proj_xxxxxxxxxx</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Modell für Produkttexte</label>
                    <div class="col-sm-9">
                        <select class="form-control" name="model">
                            {if $availableModels && count($availableModels) > 0}
                                {foreach from=$availableModels item=modelOption}
                                    <option value="{$modelOption.id}" {if $model == $modelOption.id}selected{/if}>{$modelOption.name}</option>
                                {/foreach}
                            {else}
                                <option value="gpt-4o-mini" {if $model == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (empfohlen, günstig)</option>
                                <option value="gpt-4o" {if $model == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualität)</option>
                            {/if}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Modell für Bilderkennung (ALT-Texte)</label>
                    <div class="col-sm-9">
                        <select class="form-control" name="vision_model">
                            <option value="gpt-4o" {if $visionModel == 'gpt-4o'}selected{/if}>GPT-4o (beste Qualität, empfohlen)</option>
                            <option value="gpt-4o-mini" {if $visionModel == 'gpt-4o-mini'}selected{/if}>GPT-4o-mini (schneller, günstiger)</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <button type="button" class="btn btn-default" onclick="updateModels()">
                            <i class="fa fa-refresh"></i> Modelle von OpenAI aktualisieren
                        </button>
                        <p class="help-block" id="update-status"></p>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <div class="panel panel-info" style="margin-top: 30px;">
                            <div class="panel-heading">
                                <h4 class="panel-title"><i class="fa fa-info-circle"></i> Verwendung</h4>
                            </div>
                            <div class="panel-body">
                                <ol>
                                    <li>Konfigurieren Sie Ihren OpenAI API Key und wählen Sie ein Modell</li>
                                    <li>Passen Sie optional die Prompts in den anderen Tabs an</li>
                                    <li>Öffnen Sie ein Produkt in der Artikelverwaltung</li>
                                    <li>Klicken Sie auf "SEO-Texte mit KI generieren"</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Produkt Prompts -->
            <div role="tabpanel" class="tab-pane" id="tab-product-prompts">
                <h3><i class="fa fa-file-text"></i> Prompt-Konfiguration für Produkttexte</h3>

                <div class="form-group">
                    <label class="col-sm-3 control-label">System-Prompt</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" name="system_prompt" rows="4">{$systemPrompt|escape}</textarea>
                        <p class="help-block">Definiert die Rolle und das grundsätzliche Verhalten der KI</p>
                        <button type="button" class="btn btn-default btn-sm" onclick="resetSystemPrompt()">
                            <i class="fa fa-undo"></i> Standard wiederherstellen
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">User-Prompt (Aufgabenstellung)</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" name="user_prompt" rows="20">{$userPrompt|escape}</textarea>
                        <div class="placeholder-info">
                            <strong>Verfügbare Platzhalter:</strong><br>
                            <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                            <code>{literal}{ldelim}ORIGINAL_TEXT{rdelim}{/literal}</code> - Original Produktbeschreibung<br>
                            <code>{literal}{ldelim}LANGUAGE{rdelim}{/literal}</code> - Zielsprache<br>
                            <code>{literal}{ldelim}BRAND_LINE{rdelim}{/literal}</code> - Marke<br>
                            <code>{literal}{ldelim}CATEGORY_LINE{rdelim}{/literal}</code> - Kategorie
                        </div>
                        <button type="button" class="btn btn-default btn-sm" onclick="resetUserPrompt()">
                            <i class="fa fa-undo"></i> Standard wiederherstellen
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <div class="library-section">
                            <h4><i class="fa fa-book"></i> Prompt-Bibliothek für Produkttexte</h4>
                            <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen.</p>
                            <button type="button" class="btn btn-primary" onclick="showProductPromptLibrary()">
                                <i class="fa fa-book"></i> Bibliothek öffnen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Vision Prompts -->
            <div role="tabpanel" class="tab-pane" id="tab-vision-prompts">
                <h3><i class="fa fa-image"></i> Prompt-Konfiguration für ALT-Texte</h3>

                <div class="form-group">
                    <label class="col-sm-3 control-label">System-Prompt für ALT-Texte</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" name="vision_system_prompt" rows="4">{$visionSystemPrompt|escape}</textarea>
                        <p class="help-block">Definiert die Rolle für barrierefreie Bildbeschreibungen</p>
                        <button type="button" class="btn btn-default btn-sm" onclick="resetVisionSystemPrompt()">
                            <i class="fa fa-undo"></i> Standard wiederherstellen
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">User-Prompt für ALT-Texte</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" name="vision_user_prompt" rows="15">{$visionUserPrompt|escape}</textarea>
                        <div class="placeholder-info">
                            <strong>Verfügbare Platzhalter:</strong><br>
                            <code>{literal}{ldelim}PRODUCT_NAME{rdelim}{/literal}</code> - Produktname<br>
                            <code>{literal}{ldelim}LANGUAGES{rdelim}{/literal}</code> - Liste der gewünschten Sprachen
                        </div>
                        <button type="button" class="btn btn-default btn-sm" onclick="resetVisionUserPrompt()">
                            <i class="fa fa-undo"></i> Standard wiederherstellen
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <div class="library-section" style="border-left-color: #5bc0de;">
                            <h4><i class="fa fa-book"></i> Prompt-Bibliothek für ALT-Texte</h4>
                            <p>Speichern und verwalten Sie mehrere Prompt-Vorlagen.</p>
                            <button type="button" class="btn btn-info" onclick="showVisionPromptLibrary()">
                                <i class="fa fa-book"></i> Bibliothek öffnen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Form Actions -->
        <div class="form-group" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <div class="col-sm-offset-3 col-sm-9">
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-save"></i> Einstellungen speichern
                </button>
                <a href="admin.php?do=ModuleCenter" class="btn btn-default">
                    <i class="fa fa-arrow-left"></i> Zurück zum Modulcenter
                </a>
            </div>
        </div>
    </form>

    <!-- Bootstrap 3 Modal: Add Prompt -->
    <div class="modal fade" id="add-prompt-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"><i class="fa fa-plus-circle"></i> Neuen Prompt speichern</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Label/Name *</label>
                        <input type="text" class="form-control" id="new-prompt-label">
                    </div>
                    <div class="form-group">
                        <label>Beschreibung</label>
                        <textarea class="form-control" id="new-prompt-description" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>System-Prompt *</label>
                        <textarea class="form-control" id="new-prompt-system" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>User-Prompt *</label>
                        <textarea class="form-control" id="new-prompt-user" rows="10"></textarea>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="new-prompt-default"> Als Standard-Prompt setzen
                        </label>
                    </div>
                    <p id="save-prompt-status" class="help-block"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewPrompt()">
                        <i class="fa fa-save"></i> Prompt speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 3 Modal: Edit Prompt -->
    <div class="modal fade" id="edit-prompt-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"><i class="fa fa-edit"></i> Prompt bearbeiten</h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-prompt-id">
                    <div class="form-group">
                        <label>Label/Name *</label>
                        <input type="text" class="form-control" id="edit-prompt-label">
                    </div>
                    <div class="form-group">
                        <label>Beschreibung</label>
                        <textarea class="form-control" id="edit-prompt-description" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>System-Prompt *</label>
                        <textarea class="form-control" id="edit-prompt-system" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label>User-Prompt *</label>
                        <textarea class="form-control" id="edit-prompt-user" rows="10"></textarea>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="edit-prompt-default"> Als Standard-Prompt setzen
                        </label>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" id="edit-prompt-active" checked> Aktiv
                        </label>
                    </div>
                    <p id="edit-prompt-status" class="help-block"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedPrompt()">
                        <i class="fa fa-save"></i> Änderungen speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 3 Modal: Product Prompt Library -->
    <div class="modal fade" id="product-library-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"><i class="fa fa-book"></i> Prompt-Bibliothek für Produkttexte</h4>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <button type="button" class="btn btn-success" onclick="showAddPromptDialog('product')">
                            <i class="fa fa-plus"></i> Neuen Prompt erstellen
                        </button>
                    </div>
                    <div id="product-library-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        <i class="fa fa-times"></i> Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 3 Modal: Vision Prompt Library -->
    <div class="modal fade" id="vision-library-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"><i class="fa fa-book"></i> Prompt-Bibliothek für ALT-Texte</h4>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <button type="button" class="btn btn-success" onclick="showAddPromptDialog('vision')">
                            <i class="fa fa-plus"></i> Neuen Prompt erstellen
                        </button>
                    </div>
                    <div id="vision-library-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        <i class="fa fa-times"></i> Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Default Prompts
var defaultSystemPrompt = 'Du bist ein professioneller E-Commerce SEO-Texter. Du antwortest immer im angeforderten JSON-Format.';
var defaultUserPrompt = `Du bist ein Experte für E-Commerce SEO und Produkttexte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}
{ldelim}BRAND_LINE{rdelim}{ldelim}CATEGORY_LINE{rdelim}
Original-Produkttext:
{ldelim}ORIGINAL_TEXT{rdelim}

AUFGABE:
Erstelle einen SEO-optimierten Produkttext in {ldelim}LANGUAGE{rdelim}.

FORMAT DER ANTWORT (JSON):
{
  "product_description": "Der optimierte Produkttext hier...",
  "meta_title": "SEO Meta-Titel",
  "meta_description": "SEO Meta-Description"
}

Antworte NUR mit dem JSON-Objekt, ohne zusätzlichen Text.`;

var defaultVisionSystemPrompt = 'Du bist ein Experte für barrierefreie Bildbeschreibungen.';
var defaultVisionUserPrompt = `Analysiere dieses Produktbild und erstelle barrierefreie ALT-Texte.

Produkt: {ldelim}PRODUCT_NAME{rdelim}

Erstelle ALT-Texte für folgende Sprachen:
{ldelim}LANGUAGES{rdelim}

Antworte NUR mit einem JSON-Objekt in diesem Format:
{
  "de": "ALT-Text in Deutsch",
  "en": "ALT-text in English"
}`;

// Reset Functions
function resetSystemPrompt() {
    if (confirm('System-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="system_prompt"]').value = defaultSystemPrompt;
    }
}

function resetUserPrompt() {
    if (confirm('User-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="user_prompt"]').value = defaultUserPrompt;
    }
}

function resetVisionSystemPrompt() {
    if (confirm('Vision System-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="vision_system_prompt"]').value = defaultVisionSystemPrompt;
    }
}

function resetVisionUserPrompt() {
    if (confirm('Vision User-Prompt auf Standard zurücksetzen?')) {
        document.querySelector('textarea[name="vision_user_prompt"]').value = defaultVisionUserPrompt;
    }
}

// Update Models
function updateModels() {
    var statusEl = document.getElementById('update-status');
    statusEl.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Lade Modelle...';
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdateModels', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusEl.innerHTML = '<i class="fa fa-check"></i> ' + data.count + ' Modelle aktualisiert. Seite wird neu geladen...';
            setTimeout(() => location.reload(), 1500);
        } else {
            statusEl.innerHTML = '<i class="fa fa-times"></i> Fehler: ' + data.error;
        }
    });
}

// Prompt Library Functions
function showProductPromptLibrary() {
    jQuery('#product-library-modal').modal('show');
    loadPromptLibraryInto('product', 'product-library-list');
}

function hideProductLibrary() {
    jQuery('#product-library-modal').modal('hide');
}

function showVisionPromptLibrary() {
    jQuery('#vision-library-modal').modal('show');
    loadPromptLibraryInto('vision', 'vision-library-list');
}

function hideVisionLibrary() {
    jQuery('#vision-library-modal').modal('hide');
}

function loadPromptLibraryInto(promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);
    listEl.innerHTML = '<p><i class="fa fa-spinner fa-spin"></i> Lade Prompts...</p>';

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=1&prompt_type=' + promptType)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPromptLibraryInto(data.prompts, promptType, targetElementId);
        } else {
            listEl.innerHTML = '<p>Fehler: ' + data.error + '</p>';
        }
    });
}

function displayPromptLibraryInto(prompts, promptType, targetElementId) {
    var listEl = document.getElementById(targetElementId);
    if (!prompts || prompts.length === 0) {
        listEl.innerHTML = '<p>Noch keine Prompts gespeichert.</p>';
        return;
    }

    var html = '<table class="library-table table table-striped table-bordered"><thead><tr><th>Label</th><th>Beschreibung</th><th>Standard</th><th>Aktionen</th></tr></thead><tbody>';
    prompts.forEach(function(prompt) {
        html += '<tr>';
        html += '<td><strong>' + escapeHtml(prompt.prompt_label) + '</strong></td>';
        html += '<td>' + (prompt.prompt_description || '-') + '</td>';
        html += '<td>' + (prompt.is_default ? '<i class="fa fa-star"></i>' : '-') + '</td>';
        html += '<td>';
        html += '<button class="btn btn-sm btn-info" onclick="loadPromptToForm(' + prompt.prompt_id + ', \'' + promptType + '\')">Laden</button> ';
        html += '<button class="btn btn-sm btn-default" onclick="editPrompt(' + prompt.prompt_id + ')">Bearbeiten</button> ';
        html += '<button class="btn btn-sm btn-danger" onclick="deletePromptAndReload(' + prompt.prompt_id + ', \'' + promptType + '\', \'' + targetElementId + '\')">Löschen</button>';
        html += '</td>';
        html += '</tr>';
    });
    html += '</tbody></table>';
    listEl.innerHTML = html;
}

function loadPromptToForm(promptId, promptType) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompts&active_only=0')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompts.find(p => p.prompt_id == promptId);
            if (prompt) {
                if (promptType === 'vision') {
                    document.querySelector('textarea[name="vision_system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="vision_user_prompt"]').value = prompt.user_prompt;
                    hideVisionLibrary();
                } else {
                    document.querySelector('textarea[name="system_prompt"]').value = prompt.system_prompt;
                    document.querySelector('textarea[name="user_prompt"]').value = prompt.user_prompt;
                    hideProductLibrary();
                }
                alert('Prompts geladen. Vergessen Sie nicht zu speichern!');
            }
        }
    });
}

function showAddPromptDialog(promptType) {
    if (promptType === 'vision') {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="vision_system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="vision_user_prompt"]').value;
    } else {
        document.getElementById('new-prompt-system').value = document.querySelector('textarea[name="system_prompt"]').value;
        document.getElementById('new-prompt-user').value = document.querySelector('textarea[name="user_prompt"]').value;
    }
    document.getElementById('new-prompt-label').value = '';
    document.getElementById('new-prompt-description').value = '';
    document.getElementById('new-prompt-default').checked = false;
    document.getElementById('add-prompt-modal').setAttribute('data-prompt-type', promptType || 'product');
    jQuery('#add-prompt-modal').modal('show');
}

function hideAddPromptDialog() {
    jQuery('#add-prompt-modal').modal('hide');
}

function saveNewPrompt() {
    var label = document.getElementById('new-prompt-label').value;
    var formData = new FormData();
    formData.append('label', label);
    formData.append('description', document.getElementById('new-prompt-description').value);
    formData.append('system_prompt', document.getElementById('new-prompt-system').value);
    formData.append('user_prompt', document.getElementById('new-prompt-user').value);
    formData.append('is_default', document.getElementById('new-prompt-default').checked ? '1' : '0');
    formData.append('prompt_type', document.getElementById('add-prompt-modal').getAttribute('data-prompt-type'));

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/CreatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Prompt gespeichert!');
            hideAddPromptDialog();
            if (jQuery('#product-library-modal').is(':visible')) {
                loadPromptLibraryInto('product', 'product-library-list');
            } else {
                loadPromptLibraryInto('vision', 'vision-library-list');
            }
        } else {
            alert('Fehler: ' + data.error);
        }
    });
}

function editPrompt(promptId) {
    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/GetPrompt&prompt_id=' + promptId)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            var prompt = data.prompt;
            document.getElementById('edit-prompt-id').value = prompt.prompt_id;
            document.getElementById('edit-prompt-label').value = prompt.prompt_label;
            document.getElementById('edit-prompt-description').value = prompt.prompt_description || '';
            document.getElementById('edit-prompt-system').value = prompt.system_prompt;
            document.getElementById('edit-prompt-user').value = prompt.user_prompt;
            document.getElementById('edit-prompt-default').checked = prompt.is_default == 1;
            document.getElementById('edit-prompt-active').checked = prompt.is_active == 1;
            jQuery('#edit-prompt-modal').modal('show');
        }
    });
}

function hideEditPromptDialog() {
    jQuery('#edit-prompt-modal').modal('hide');
}

function saveEditedPrompt() {
    var formData = new FormData();
    formData.append('prompt_id', document.getElementById('edit-prompt-id').value);
    formData.append('label', document.getElementById('edit-prompt-label').value);
    formData.append('description', document.getElementById('edit-prompt-description').value);
    formData.append('system_prompt', document.getElementById('edit-prompt-system').value);
    formData.append('user_prompt', document.getElementById('edit-prompt-user').value);
    formData.append('is_default', document.getElementById('edit-prompt-default').checked ? '1' : '0');
    formData.append('is_active', document.getElementById('edit-prompt-active').checked ? '1' : '0');

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/UpdatePrompt', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Änderungen gespeichert!');
            hideEditPromptDialog();
            if (jQuery('#product-library-modal').is(':visible')) {
                loadPromptLibraryInto('product', 'product-library-list');
            } else {
                loadPromptLibraryInto('vision', 'vision-library-list');
            }
        }
    });
}

function deletePromptAndReload(promptId, promptType, targetElementId) {
    if (!confirm('Prompt wirklich löschen?')) return;

    var params = new URLSearchParams();
    params.append('prompt_id', promptId);

    fetch('admin.php?do=AIProductOptimizerModuleCenterModule/DeletePrompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadPromptLibraryInto(promptType, targetElementId);
        }
    });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Explicit Tab Initialization for Bootstrap 3
jQuery(document).ready(function() {
    // Manually initialize tab switching if data-toggle doesn't work
    jQuery('.nav-tabs a[data-toggle="tab"]').on('click', function (e) {
        e.preventDefault();
        jQuery(this).tab('show');
    });

    // Alternative: If Bootstrap tab() is not available, use manual show/hide
    jQuery('.nav-tabs a').on('click', function(e) {
        e.preventDefault();

        // Remove active from all tabs and panes
        jQuery('.nav-tabs li').removeClass('active');
        jQuery('.tab-pane').removeClass('active');

        // Add active to clicked tab
        jQuery(this).parent().addClass('active');

        // Show corresponding pane
        var target = jQuery(this).attr('href');
        jQuery(target).addClass('active');
    });

    console.log('AI Product Optimizer: Tabs initialized');
});
</script>
